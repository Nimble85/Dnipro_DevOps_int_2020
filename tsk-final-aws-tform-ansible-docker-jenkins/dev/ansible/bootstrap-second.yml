---
- hosts: dev
  become: yes
  remote_user: ubuntu
  tasks:
    - name: Update all packages
      apt:
        name: "*"
        state: latest
        update_cache: yes

    - name: Install Software
      apt:
        name:
          - awscli
          - git
          - openjdk-8-jdk
          - openjdk-8-jre-headless
          - htop
          - screen
          - mc
          - maven
          - libxml-writer-perl
          - libxml-sax-base-perl
          - libxml-perl
          - libxml-filter-saxt-perl
          - libtext-glob-perl
          - postgresql

############ postgres ###########
    - name: configure posttgres
      shell: |
        cat << EOF > /tmp/pg_hba.conf
        local   all             all                                     trust
        host    all             all             all                     trust
        host    all             all             127.0.0.1/32            trust
        host    all             all             ::1/128                 trust
        host    all             all             0.0.0.0/0              password
        EOF
        mv /tmp/pg_hba.conf /etc/postgresql/10/main/pg_hba.conf
        sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/g" /etc/postgresql/10/main/postgresql.conf
        PSQL_USER=ubuntu
        PSQL_PWD=ubuntu
        su postgres -c "psql -c \"CREATE ROLE $PSQL_USER SUPERUSER CREATEDB CREATEROLE INHERIT LOGIN ENCRYPTED PASSWORD '$PSQL_PWD'\";"
      ignore_errors: yes

    - name: start psql
      service:
        name: postgresql
        enabled: yes
        state: started


#   - name: install tomcat
#     shell: |
#       wget "https://apache.volia.net/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.tar.gz" -O apache-tomcat.tar.gz
#       mkdir /home/ubuntu/tomcat/ -p
#       tar -zxf apache-tomcat.tar.gz -C /home/ubuntu/tomcat/ --strip-components=1

#  - name: solr instal
#    shell: |
#      wget http://archive.apache.org/dist/lucene/solr/7.2.1/solr-7.2.1.tgz
#      tar xzf solr-7.2.1.tgz solr-7.2.1/bin/install_solr_service.sh --strip-components=2
#      bash ./install_solr_service.sh solr-7.2.1.tgz
#      systemctl enable solr
#    args:
#      executable: /bin/bash        


############# begin section check status installed software #####
    - name: check Java
      shell: "java -version"
      register: java_ver
    - debug:
        var: java_ver

    - name: check maven
      shell: "mvn -version"
      register: mvn_info
    - debug:
        var: mvn_info
############# end section check status installed software #####

#    - name: Clone git repo
#
#        repo: https://github.com/intermine/intermine.git
#        repo: https://github.com/fenixra73/intermine.git
#        dest: /home/ubuntu/intermine
#        update: no

    - name: Chown
      file:
        path: /home/ubuntu/
        owner: ubuntu
        group: ubuntu
        recurse: yes

#    - name: Install intermine
#      become: yes
#      become_user: ubuntu
#      shell: |
#        cd /home/ubuntu/intermine/testmine  
#        /home/ubuntu/intarmine/testmine/setup.sh  

#    - name: try start intermine
#    #      become: yes
#    #      become_user: ubuntu
#    #      shell: "screen /home/ubuntu/intermine/testmine/gradlew tomcatstartwar --no-daemon &"
  
  

